name: "Validate Automation Config"

on:
  push:
    branches: [ main ]
    paths:
      - '.github/**'
  pull_request:
    paths:
      - '.github/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Automation Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate workflow files
        run: |
          echo "## Workflow Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count workflows
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)
          echo "✅ Found $WORKFLOW_COUNT workflow files" >> $GITHUB_STEP_SUMMARY
          
          # List all workflows
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflows:" >> $GITHUB_STEP_SUMMARY
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              name=$(basename "$workflow")
              echo "- $name" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Validate Dependabot config
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependabot Configuration:" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".github/dependabot.yml" ]; then
            echo "✅ Dependabot config exists" >> $GITHUB_STEP_SUMMARY
            
            # Count update configurations
            UPDATE_COUNT=$(grep -c "package-ecosystem:" .github/dependabot.yml || echo "0")
            echo "- Package ecosystems configured: $UPDATE_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Dependabot config not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Validate CODEOWNERS
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CODEOWNERS Configuration:" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".github/CODEOWNERS" ]; then
            echo "✅ CODEOWNERS file exists" >> $GITHUB_STEP_SUMMARY
            
            # Count rules
            RULE_COUNT=$(grep -c "^[^#]" .github/CODEOWNERS | grep -v "^$" | wc -l || echo "0")
            echo "- Code ownership rules: $RULE_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ CODEOWNERS file not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate Issue Templates
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issue Templates:" >> $GITHUB_STEP_SUMMARY
          
          if [ -d ".github/ISSUE_TEMPLATE" ]; then
            TEMPLATE_COUNT=$(find .github/ISSUE_TEMPLATE -name "*.yml" -o -name "*.md" | wc -l)
            echo "✅ Issue templates directory exists" >> $GITHUB_STEP_SUMMARY
            echo "- Templates configured: $TEMPLATE_COUNT" >> $GITHUB_STEP_SUMMARY
            
            for template in .github/ISSUE_TEMPLATE/*.yml .github/ISSUE_TEMPLATE/*.md; do
              if [ -f "$template" ]; then
                name=$(basename "$template")
                echo "  - $name" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "⚠️ Issue templates directory not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate PR Template
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Request Template:" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".github/PULL_REQUEST_TEMPLATE.md" ]; then
            echo "✅ PR template exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ PR template not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate Labeler Config
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Auto-labeling Configuration:" >> $GITHUB_STEP_SUMMARY
          
          if [ -f ".github/labeler.yml" ]; then
            echo "✅ Labeler config exists" >> $GITHUB_STEP_SUMMARY
            
            # Count label rules (approximate)
            LABEL_COUNT=$(grep -c "^'" .github/labeler.yml || echo "0")
            echo "- Label rules configured: $LABEL_COUNT" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Labeler config not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check Branch Protection Config
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branch Protection:" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "branch-protection-ruleset.json" ]; then
            echo "✅ Branch protection ruleset configuration exists" >> $GITHUB_STEP_SUMMARY
            
            # Extract required checks
            if command -v jq &> /dev/null; then
              CHECKS=$(jq -r '.rules[] | select(.type=="required_status_checks") | .parameters.required_status_checks[].context' branch-protection-ruleset.json 2>/dev/null || echo "")
              if [ -n "$CHECKS" ]; then
                echo "- Required status checks:" >> $GITHUB_STEP_SUMMARY
                echo "$CHECKS" | while read check; do
                  echo "  - $check" >> $GITHUB_STEP_SUMMARY
                done
              fi
            else
              echo "- Install jq to see detailed check requirements" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ Branch protection config not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validation Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All automation configurations have been validated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review AUTOMATION-SETUP.md for configuration instructions" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable required features in GitHub repository settings" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor the Actions tab for workflow execution" >> $GITHUB_STEP_SUMMARY

      - name: Install actionlint
        run: |
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          echo "$PWD" >> $GITHUB_PATH

      - name: Lint workflow files
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflow Linting Results:" >> $GITHUB_STEP_SUMMARY
          
          # Run actionlint on all workflow files
          if ./actionlint -color .github/workflows/*.yml 2>&1 | tee lint-results.txt; then
            echo "✅ All workflows passed linting" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Some workflows have linting warnings (non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint-results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

name: Comprehensive CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Setup & Cache
    runs-on: ubuntu-latest
    outputs:
      pnpm-cache-hit: ${{ steps.pnpm-cache.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm 9
        run: corepack prepare pnpm@9.0.0 --activate

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm dependencies
        id: pnpm-cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.STORE_PATH }}
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        if: steps.pnpm-cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

  lint:
    name: Lint Code
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm 9
        run: corepack prepare pnpm@9.0.0 --activate

      - name: Restore pnpm cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: Run ESLint
        run: pnpm lint

      - name: Check formatting
        run: pnpm format --check || echo "Formatting issues found - run 'pnpm format' locally"

  typecheck:
    name: TypeScript Type Check
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm 9
        run: corepack prepare pnpm@9.0.0 --activate

      - name: Restore pnpm cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: TypeScript type check
        run: pnpm exec tsc --noEmit --skipLibCheck

  test:
    name: Unit & Integration Tests
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm 9
        run: corepack prepare pnpm@9.0.0 --activate

      - name: Restore pnpm cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: Run tests
        run: pnpm test
        env:
          CI: true

      - name: Generate coverage report
        run: pnpm coverage:ci

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  build:
    name: Build All Packages
    needs: [lint, typecheck, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm 9
        run: corepack prepare pnpm@9.0.0 --activate

      - name: Restore pnpm cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: Build all packages
        run: pnpm build

      - name: Re-link binaries
        run: pnpm install

      - name: Cache build outputs
        uses: actions/cache@v3
        with:
          path: |
            **/dist
            **/build
          key: ${{ runner.os }}-build-${{ github.sha }}

      - name: Upload Discord Bot build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: discord-bot-build
          path: apps/discord-bot/dist
          retention-days: 7

      - name: Upload API build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: api-build
          path: apps/api/dist
          retention-days: 7

      - name: Upload Dashboard build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dashboard-build
          path: services/dashboard/dist
          retention-days: 7

  security-audit:
    name: Security Audit
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm 9
        run: corepack prepare pnpm@9.0.0 --activate

      - name: Restore pnpm cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          PUPPETEER_SKIP_DOWNLOAD: 'true'

      - name: Run pnpm audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

      - name: Generate audit report
        run: pnpm audit --json > audit-report.json || true

      - name: Upload audit report
        uses: actions/upload-artifact@v3
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30

  codeql:
    name: CodeQL Security Scan
    needs: setup
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript,typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  dependency-drift:
    name: Check Dependency Drift
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm 9
        run: corepack prepare pnpm@9.0.0 --activate

      - name: Check for outdated dependencies
        run: pnpm -r outdated --format json > outdated-report.json || true

      - name: Upload outdated report
        uses: actions/upload-artifact@v3
        with:
          name: outdated-dependencies
          path: outdated-report.json
          retention-days: 30

      - name: Check for duplicate dependencies
        run: |
          echo "Checking for duplicate dependencies..."
          pnpm list --depth Infinity | grep -E "\s{2}\S" | sort | uniq -c | sort -rn > duplicates.txt || true
          cat duplicates.txt

      - name: Upload duplicates report
        uses: actions/upload-artifact@v3
        with:
          name: duplicate-dependencies
          path: duplicates.txt
          retention-days: 30

  notify-failure:
    name: Notify on Failure
    needs: [lint, typecheck, test, build, security-audit, codeql]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_CI_WEBHOOK }}
          status: failure
          title: "CI Pipeline Failed"
          description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **Workflow:** ${{ github.workflow }}
            
            One or more jobs failed. Please check the workflow run for details.
          color: 0xff0000
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify-success:
    name: Notify on Success
    needs: [lint, typecheck, test, build, security-audit, codeql]
    if: success() && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_CI_WEBHOOK }}
          status: success
          title: "CI Pipeline Succeeded"
          description: |
            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            
            All checks passed successfully!
          color: 0x00ff00

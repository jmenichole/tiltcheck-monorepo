name: Secret Scan

on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - '*.md'
  push:
    branches: [ main, feat/** ]
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  trufflehog:
    name: TruffleHog Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan (diff)
        uses: trufflesecurity/trufflehog@main
        with:
          path: '.'
          extra_args: '--only-verified --fail-if-found --max-depth 1 --exclude_paths .gitignore'
        continue-on-error: true
        id: diffscan

      - name: Upload SARIF (if findings)
        if: steps.diffscan.outcome == 'failure'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trufflehog_results.sarif

      - name: Full Repo Scan (scheduled only)
        if: github.event_name == 'schedule'
        uses: trufflesecurity/trufflehog@main
        with:
          path: '.'
          extra_args: '--only-verified --max-depth 3'

      - name: Comment on PR
        if: steps.diffscan.outcome == 'failure' && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: trufflehog-secret-scan
          message: |
            ⚠️ Potential secrets detected by TruffleHog.
            Review the security tab or generated SARIF for details.
            Rotate any exposed credentials immediately.

  entropy-precheck:
    name: Entropy Heuristic Pre-Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Simple entropy heuristic (non-blocking)
        run: |
          set +e
          echo "Running simple entropy grep (length>=40 base64-like)."
          git ls-files | while read f; do
            case "$f" in node_modules/*|dist/*|.git/*) continue ;; esac
            if grep -E '[A-Za-z0-9/+]{40,}={0,2}' "$f" >/dev/null 2>&1; then
              echo "Possible secret candidate: $f"
            fi
          done || true
        continue-on-error: true

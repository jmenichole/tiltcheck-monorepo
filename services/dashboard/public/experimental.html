<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TiltCheck Experimental Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --color-bg:#0a0a0a; --color-surface-0:#0f0f0f; --color-surface-1:#111; --color-surface-2:#1a1a1a;
    --color-border:#222; --color-accent:#00d4aa; --color-accent-alt:#00a8ff; --color-danger:#ff6b6b;
    --color-text:#fff; --color-text-secondary:#ccc; --color-text-muted:#888;
    --radius-sm:6px; --radius-md:12px; --radius-lg:18px; --shadow-sm:0 2px 4px rgba(0,0,0,0.4);
    --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:24px; --space-6:32px;
  }
  * { box-sizing:border-box; }
  body { margin:0; font-family:Inter, system-ui, -apple-system, sans-serif; background:var(--color-bg); color:var(--color-text); }
  header { padding:32px 24px 20px; background:linear-gradient(135deg,#1a1a2e 0%, #16213e 100%); border-bottom:2px solid var(--color-accent); }
  header h1 { margin:0 0 6px; font-size:2rem; }
  header .lede { color:var(--color-text-muted); font-size:0.95rem; }
  nav { padding:10px 24px; background:#0f0f0f; display:flex; gap:18px; font-size:0.85rem; }
  nav a { color:var(--color-text-secondary); text-decoration:none; }
  nav a:hover { color:var(--color-accent); }
  main { max-width:1400px; margin:0 auto; padding:24px; display:grid; gap:24px; grid-template-columns: repeat(auto-fit,minmax(380px,1fr)); }
  .panel { background:var(--color-surface-2); border:1px solid var(--color-border); border-radius:var(--radius-md); padding:18px 20px 22px; display:flex; flex-direction:column; min-height:340px; }
  .panel h2 { margin:0 0 12px; font-size:1.05rem; letter-spacing:0.05em; text-transform:uppercase; color:var(--color-text-secondary); }
  /* Summary Bar */
  #summaryBar { grid-column:1/-1; display:flex; flex-wrap:wrap; gap:18px; }
  .summary-item { flex:1 1 160px; background:var(--color-surface-1); border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:12px 14px; min-width:160px; }
  .summary-label { font-size:0.65rem; text-transform:uppercase; letter-spacing:0.06em; color:var(--color-text-muted); }
  .summary-value { font-size:1.2rem; font-weight:600; margin-top:4px; }
  /* Gauges */
  .gauge-row { display:flex; gap:20px; flex-wrap:wrap; }
  .gauge { background:var(--color-surface-1); border:1px solid var(--color-border); border-radius:var(--radius-sm); padding:14px 16px; display:flex; align-items:center; gap:14px; flex:1 1 240px; min-width:240px; }
  .gauge-ring { width:72px; height:72px; position:relative; }
  .gauge-ring svg { width:100%; height:100%; transform:rotate(-90deg); }
  .gauge-ring circle { fill:none; stroke-width:10; stroke-linecap:round; }
  .gauge-meta { display:flex; flex-direction:column; gap:4px; }
  .gauge-label { font-size:0.7rem; letter-spacing:0.06em; text-transform:uppercase; color:var(--color-text-muted); }
  .gauge-value { font-size:1.3rem; font-weight:600; }
  .gauge-desc { font-size:0.65rem; color:var(--color-text-secondary); line-height:1.2; }
  /* Timeline */
  #timelineList { list-style:none; margin:0; padding:0; flex:1; overflow:auto; }
  .timeline-item { padding:10px 12px; border-left:4px solid var(--color-accent); background:var(--color-surface-1); border:1px solid var(--color-border); border-left-color:var(--color-accent); margin-bottom:10px; border-radius:6px; }
  .timeline-time { font-size:0.7rem; letter-spacing:0.05em; text-transform:uppercase; color:var(--color-text-muted); }
  .timeline-text { font-size:0.85rem; margin-top:4px; color:var(--color-text-secondary); }
  /* Anomaly Heatmap */
  .heatmap-wrap { position:relative; flex:1; display:flex; justify-content:center; align-items:center; }
  .heatmap { position:relative; width:260px; height:260px; }
  .ring { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); border:1px solid var(--color-border); border-radius:50%; }
  .ring.r1 { width:260px; height:260px; }
  .ring.r2 { width:200px; height:200px; }
  .ring.r3 { width:140px; height:140px; }
  .ring.r4 { width:80px; height:80px; background:rgba(255,255,255,0.02); }
  .anomaly-point { position:absolute; width:10px; height:10px; background:var(--color-danger); border-radius:50%; box-shadow:0 0 8px var(--color-danger); opacity:0; transform:scale(.4); animation:pointIn .4s ease forwards; }
  @keyframes pointIn { to { opacity:1; transform:scale(1);} }
  .anomaly-info { text-align:center; font-size:0.75rem; color:var(--color-text-secondary); margin-top:10px; }
  /* Utility */
  .muted { color:var(--color-text-muted); }
  .flex-col { display:flex; flex-direction:column; }
  /* Scrollbar minimal */
  #timelineList::-webkit-scrollbar { width:6px; }
  #timelineList::-webkit-scrollbar-track { background:var(--color-surface-0); }
  #timelineList::-webkit-scrollbar-thumb { background:var(--color-border); border-radius:6px; }
  @media (max-width:860px){ .gauge { flex:1 1 100%; } }
  /* Legal badges */
  .legal-badges { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  .legal-badge { padding:4px 8px; font-size:0.55rem; letter-spacing:0.06em; text-transform:uppercase; border-radius:4px; border:1px solid var(--color-border); background:var(--color-surface-1); color:var(--color-text-secondary); font-weight:600; }
  .legal-badge[data-severity="3"] { border-color: var(--color-danger); color: var(--color-danger); }
  .legal-badge[data-severity="2"] { border-color: var(--color-accent-alt); color: var(--color-accent-alt); }
  .legal-badge[data-severity="1"] { border-color: var(--color-accent); color: var(--color-accent); }
</style>
</head>
<body>
  <header role="banner">
    <h1 id="viewTitle">Experimental Trust View</h1>
    <p class="lede" id="viewDesc">Prototype layout for fairness signals, payout flow, and anomaly clustering.</p>
  </header>
  <nav role="navigation" aria-label="Primary">
    <a href="/dashboard">Classic Dashboard</a>
    <a href="/components/trust-gauges.html">Gauge Gallery</a>
    <a href="#timeline" aria-controls="timeline">Payout Timeline</a>
    <a href="#anomalies" aria-controls="anomalies">Anomalies</a>
  </nav>
  <main>
    <div id="summaryBar">
      <div class="summary-item"><div class="summary-label">Games Monitored</div><div class="summary-value" id="sumGames">--</div></div>
      <div class="summary-item"><div class="summary-label">Events / Min</div><div class="summary-value" id="sumEvents">--</div></div>
      <div class="summary-item"><div class="summary-label">Low Severity %</div><div class="summary-value" id="sumLowSev">--</div></div>
      <div class="summary-item"><div class="summary-label">Avg Casino Score</div><div class="summary-value" id="sumCasinoScore">--</div></div>
      <div id="legalBadges" class="legal-badges" aria-label="Legal rights triggers" role="group"></div>
      <div class="summary-item" style="flex:1 1 220px; display:flex; flex-direction:column; gap:6px;">
        <label for="badgeCasino" class="summary-label">Casino (Badges)</label>
        <select id="badgeCasino" style="background:var(--color-surface-1); border:1px solid var(--color-border); color:var(--color-text); padding:6px 8px; border-radius:6px; font-size:0.7rem;"></select>
        <label for="badgeRegion" class="summary-label">Region</label>
        <select id="badgeRegion" style="background:var(--color-surface-1); border:1px solid var(--color-border); color:var(--color-text); padding:6px 8px; border-radius:6px; font-size:0.7rem;">
          <option value="US">US</option>
          <option value="CA">CA</option>
          <option value="EU">EU</option>
        </select>
      </div>
    </div>
    <section class="panel" id="gauges" role="region" aria-labelledby="gaugesTitle">
      <h2 id="gaugesTitle">Fairness Signals</h2>
      <div class="gauge-row">
        <div class="gauge" id="gRng">
          <div class="gauge-ring">
            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" stroke="#222" /><circle cx="50" cy="50" r="42" stroke="var(--color-accent)" stroke-dasharray="0 264" id="rngArc" /></svg>
          </div>
          <div class="gauge-meta">
            <div class="gauge-label">RNG Integrity</div>
            <div class="gauge-value" id="rngVal">--</div>
            <div class="gauge-desc">Recent volatility inverse normalized.</div>
          </div>
        </div>
        <div class="gauge" id="gOdds">
          <div class="gauge-ring">
            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" stroke="#222" /><circle cx="50" cy="50" r="42" stroke="var(--color-accent-alt)" stroke-dasharray="0 264" id="oddsArc" /></svg>
          </div>
          <div class="gauge-meta">
            <div class="gauge-label">Odds Verification</div>
            <div class="gauge-value" id="oddsVal">--</div>
            <div class="gauge-desc">Consistency across recent payout deltas.</div>
          </div>
        </div>
        <div class="gauge" id="gAudit">
          <div class="gauge-ring">
            <svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="42" stroke="#222" /><circle cx="50" cy="50" r="42" stroke="var(--color-danger)" stroke-dasharray="0 264" id="auditArc" /></svg>
          </div>
          <div class="gauge-meta">
            <div class="gauge-label">Audit Score</div>
            <div class="gauge-value" id="auditVal">--</div>
            <div class="gauge-desc">Flag density against total events.</div>
          </div>
        </div>
      </div>
    </section>
    <section class="panel" id="timeline" role="region" aria-labelledby="timelineTitle">
      <h2 id="timelineTitle">Payout Timeline</h2>
      <ul id="timelineList"></ul>
    </section>
    <section class="panel" id="anomalies" role="region" aria-labelledby="anomalyTitle">
      <h2 id="anomalyTitle">Anomaly Map</h2>
      <div class="heatmap-wrap">
        <div class="heatmap" id="heatmap">
          <div class="ring r1"></div>
          <div class="ring r2"></div>
            <div class="ring r3"></div>
          <div class="ring r4"></div>
        </div>
      </div>
      <div class="anomaly-info" id="anomalyInfo" aria-live="polite">No anomalies yet.</div>
      <form id="evidenceForm" style="margin-top:12px; display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;">
        <div style="display:flex; flex-direction:column;">
          <label for="evCasino" style="font-size:0.65rem; letter-spacing:0.05em; text-transform:uppercase; color:var(--color-text-muted);">Casino ID (optional)</label>
          <input id="evCasino" name="casino" placeholder="casino-id" style="background:var(--color-surface-1); border:1px solid var(--color-border); color:var(--color-text); padding:6px 8px; border-radius:6px; font-size:0.8rem;" aria-describedby="evidenceHelp" />
        </div>
        <div style="display:flex; flex-direction:column;">
          <label for="evRegion" style="font-size:0.65rem; letter-spacing:0.05em; text-transform:uppercase; color:var(--color-text-muted);">Region</label>
          <input id="evRegion" name="region" placeholder="US" style="background:var(--color-surface-1); border:1px solid var(--color-border); color:var(--color-text); padding:6px 8px; border-radius:6px; font-size:0.8rem;" />
        </div>
        <button type="submit" id="exportEvidence" style="background:var(--color-accent); color:#000; border:none; padding:8px 14px; border-radius:6px; font-weight:600; font-size:0.75rem; cursor:pointer;">Export Evidence</button>
        <div id="evidenceStatus" class="muted" style="font-size:0.65rem;">Generate a JSON transparency package.</div>
      </form>
    </section>
  </main>
<script>
const circumference = 2 * Math.PI * 42;
function setArc(el, pct){ const c=Math.max(0,Math.min(1,pct)); el.setAttribute('stroke-dasharray', `${(c*circumference).toFixed(1)} ${circumference.toFixed(1)}`); }
async function fetchAll(){
  try {
    const [rollups, severity, alerts] = await Promise.all([
      fetch('/api/rollups/latest').then(r=>r.json()),
      fetch('/api/severity').then(r=>r.json()),
      fetch('/api/alerts').then(r=>r.json())
    ]);
    updateSummary(rollups, severity);
    updateGauges(rollups, severity);
    updateTimeline(rollups); // derive recent payouts from domain/casino movers if available
    updateAnomalies(alerts);
  } catch(e){ /* silent for prototype */ }
}
function updateSummary(rollups, severity){
  const casinos = Object.values(rollups?.casino?.casinos||{});
  const avgScore = casinos.length? casinos.reduce((a,c)=>a+(c.lastScore||0),0)/casinos.length : 0;
  document.getElementById('sumCasinoScore').textContent = Math.round(avgScore);
  const buckets = severity?.buckets||{}; let total=0, low=0; Object.entries(buckets).forEach(([sev,count])=>{total+=count; if(+sev<=2) low+=count;});
  document.getElementById('sumLowSev').textContent = total? (Math.round((low/total)*100)+'%') : '--';
  // Events/min & games monitored placeholder until backend exposes metrics
  document.getElementById('sumEvents').textContent = total || '--';
  document.getElementById('sumGames').textContent = casinos.length || '--';
}
async function refreshLegalBadges(){
  try {
    const rollups = await fetch('/api/rollups/latest').then(r=>r.json());
    const casinosMap = rollups?.casino?.casinos||{};
    const selectCasino = document.getElementById('badgeCasino');
    if(selectCasino && !selectCasino.dataset.populated){
      const entries = Object.keys(casinosMap);
      selectCasino.innerHTML = '<option value="">(all)</option>' + entries.map(c=>`<option value="${c}">${c}</option>`).join('');
      selectCasino.dataset.populated = 'true';
    }
    const chosenCasino = selectCasino ? selectCasino.value : '';
    const regionSel = document.getElementById('badgeRegion');
    const region = regionSel ? regionSel.value : 'US';
    const url = `/api/legal-rights/evaluate?region=${region}${chosenCasino?`&casino=${encodeURIComponent(chosenCasino)}`:''}`;
    const data = await fetch(url).then(r=>r.json());
    const container = document.getElementById('legalBadges');
    container.innerHTML='';
    if(!data.triggers || !data.triggers.length){
      const empty = document.createElement('span'); empty.className='legal-badge'; empty.textContent='NO TRIGGERS'; container.appendChild(empty); return;
    }
    data.triggers.forEach(t => {
      const badge = document.createElement('span');
      badge.className='legal-badge'; badge.dataset.severity = (t.severity||1).toString();
      badge.textContent = t.code.replace(/_/g,' ');
      container.appendChild(badge);
    });
  } catch(e){ /* silent */ }
}
function updateGauges(rollups, severity){
  // RNG Integrity: invert volatility (use average abs totalDelta among casinos)
  const casinos = Object.values(rollups?.casino?.casinos||{});
  const avgVol = casinos.length? casinos.reduce((a,c)=> a + Math.abs(c.totalDelta||0),0)/casinos.length : 0;
  const rngScore = 100 - Math.min(100, avgVol); // crude inverse
  document.getElementById('rngVal').textContent = Math.round(rngScore)+'%'; setArc(document.getElementById('rngArc'), rngScore/100);
  // Odds Verification: proportion of mid severities (3) vs total (lower better)
  const buckets = severity?.buckets||{}; let total=0, mid=0; Object.entries(buckets).forEach(([sev,count])=>{total+=count; if(+sev===3) mid+=count;});
  const oddsScore = total? 100 - (mid/total)*100 : 0; document.getElementById('oddsVal').textContent = Math.round(oddsScore)+'%'; setArc(document.getElementById('oddsArc'), oddsScore/100);
  // Audit Score: high severity share (5) inverted
  let high=0; Object.entries(buckets).forEach(([sev,count])=>{ if(+sev===5) high+=count; });
  const auditScore = total? 100 - (high/total)*100 : 0; document.getElementById('auditVal').textContent = Math.round(auditScore)+'%'; setArc(document.getElementById('auditArc'), auditScore/100);
}
function updateTimeline(rollups){
  const list = document.getElementById('timelineList');
  // Use casino movers as pseudo payout events
  const casinos = Object.entries(rollups?.casino?.casinos||{}).slice(0,10);
  list.innerHTML='';
  const now = new Date();
  casinos.forEach(([name,data],i)=>{
    const li=document.createElement('li'); li.className='timeline-item';
    const ts=new Date(now.getTime()-i*60000).toLocaleTimeString();
    li.innerHTML=`<div class='timeline-time'>${ts}</div><div class='timeline-text'>${name} delta ${data.totalDelta||0} score ${data.lastScore||'–'}</div>`;
    list.appendChild(li);
  });
  if(!casinos.length){ list.innerHTML='<li class="timeline-item"><div class="timeline-time">--:--</div><div class="timeline-text">No recent payout-like events available</div></li>'; }
}
function updateAnomalies(alerts){
  const map = document.getElementById('heatmap'); map.querySelectorAll('.anomaly-point').forEach(p=>p.remove());
  const arr = alerts?.alerts||[]; document.getElementById('anomalyInfo').textContent = arr.length? `${arr.length} anomalies` : 'No anomalies yet.';
  arr.slice(0,12).forEach(al=>{
    // severity influences radius + random angle
    const sev = al.severity||1; const radiusStep = 110 - (sev*18); // closer to center for higher severity
    const angle = Math.random()*Math.PI*2; const cx = 130 + Math.cos(angle)*radiusStep; const cy = 130 + Math.sin(angle)*radiusStep;
    const pt=document.createElement('div'); pt.className='anomaly-point'; pt.style.left=(cx-5)+'px'; pt.style.top=(cy-5)+'px';
    map.appendChild(pt);
  });
}
fetchAll(); setInterval(fetchAll, 12000); refreshLegalBadges(); setInterval(refreshLegalBadges, 20000);
document.getElementById('badgeCasino').addEventListener('change', refreshLegalBadges);
document.getElementById('badgeRegion').addEventListener('change', refreshLegalBadges);

// Evidence package export
document.getElementById('evidenceForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const casinoInput = document.getElementById('evCasino');
  const regionInput = document.getElementById('evRegion');
  const casino = casinoInput && casinoInput.value ? casinoInput.value.trim() : '';
  const region = regionInput && regionInput.value ? (regionInput.value.trim() || 'US') : 'US';
  const qs = new URLSearchParams(); if(casino) qs.set('casino', casino); qs.set('region', region);
  const statusEl = document.getElementById('evidenceStatus');
  statusEl.textContent = 'Building package…';
  try {
    const data = await fetch('/api/evidence/package?' + qs.toString()).then(r=>r.json());
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `tiltcheck-evidence-${casino||'all'}-${Date.now()}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    statusEl.textContent = 'Evidence package downloaded.';
  } catch(err){
    statusEl.textContent = 'Failed to generate evidence.';
  }
});

// Accessibility: add focus styles via JS injection (for older browsers lacking :focus-visible support reliably)
const style = document.createElement('style');
style.textContent = `:focus-visible { outline:2px solid var(--color-accent-alt); outline-offset:2px; }`;
document.head.appendChild(style);
</script>
</body>
</html>
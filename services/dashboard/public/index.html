<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TiltCheck Trust Dashboard</title>
<style>
 body { font-family: system-ui, sans-serif; margin: 1rem; background:#111; color:#eee; }
 h1 { margin-top:0; }
 section { margin-bottom:1.5rem; }
 table { border-collapse: collapse; width:100%; margin-top:0.5rem; }
 th, td { padding:4px 6px; border:1px solid #333; font-size:12px; }
 .neg { color:#ff5f5f; }
 .pos { color:#5fff9d; }
 .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:11px; }
 .sev1 { background:#1f3b1f; }
 .sev2 { background:#3b3b1f; }
 .sev3 { background:#3b2a1f; }
 .sev4 { background:#3b1f1f; }
 .sev5 { background:#611f1f; }
 #alerts .alert { background:#2a162a; padding:6px 8px; margin:4px 0; border-left:4px solid #d34; font-size:12px; }
 #ticker { max-height:220px; overflow:auto; font-size:12px; background:#181818; padding:6px; }
 #ticker .event { white-space:nowrap; }
 button { background:#222; color:#eee; border:1px solid #444; padding:6px 10px; cursor:pointer; }
 button:disabled { opacity:0.4; cursor:not-allowed; }
 /* Trust Gauges */
 #trustGauges { display:flex; flex-wrap:wrap; gap:18px; margin:16px 0 28px; }
 .gauge { background:#181818; border:1px solid #222; border-radius:12px; padding:12px 16px; display:flex; align-items:center; gap:14px; box-shadow:0 2px 6px rgba(0,0,0,0.4); }
 .gauge-ring { width:72px; height:72px; position:relative; }
 .gauge-ring svg { width:100%; height:100%; transform:rotate(-90deg); }
 .gauge-ring circle { fill:none; stroke-width:10; stroke-linecap:round; }
 .gauge-metric { display:flex; flex-direction:column; gap:4px; }
 .gauge-label { font-size:0.7rem; letter-spacing:0.06em; text-transform:uppercase; color:#888; }
 .gauge-value { font-size:1.35rem; font-weight:600; }
 .gauge-desc { font-size:0.7rem; color:#aaa; line-height:1.2; }
 .accent { color:#00d4aa; }
</style>
</head>
<body>
<h1>TiltCheck Trust Dashboard</h1>
<p style="margin:4px 0 18px; font-size:12px; color:#aaa;">Explore the <a href="/dashboard/experimental.html" style="color:#00d4aa; text-decoration:none;">Experimental Trust View</a> for anomaly map & evidence export.</p>
<div id="trustGauges">
  <div class="gauge" id="gaugeCasino">
    <div class="gauge-ring">
      <svg viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="42" stroke="#222"/>
        <circle cx="50" cy="50" r="42" stroke="#00d4aa" stroke-dasharray="0 264" id="casinoArc"/>
      </svg>
    </div>
    <div class="gauge-metric">
      <div class="gauge-label">Casino Trust</div>
      <div class="gauge-value" id="casinoVal">--</div>
      <div class="gauge-desc">Avg last score across tracked casinos.</div>
    </div>
  </div>
  <div class="gauge" id="gaugePayout">
    <div class="gauge-ring">
      <svg viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="42" stroke="#222"/>
        <circle cx="50" cy="50" r="42" stroke="#00a8ff" stroke-dasharray="0 264" id="payoutArc"/>
      </svg>
    </div>
    <div class="gauge-metric">
      <div class="gauge-label">Payout Reliability</div>
      <div class="gauge-value" id="payoutVal">--</div>
      <div class="gauge-desc">Lower severity share (1â€“2) vs total.</div>
    </div>
  </div>
  <div class="gauge" id="gaugeDegen">
    <div class="gauge-ring">
      <svg viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="42" stroke="#222"/>
        <circle cx="50" cy="50" r="42" stroke="#ff6b6b" stroke-dasharray="0 264" id="degenArc"/>
      </svg>
    </div>
    <div class="gauge-metric">
      <div class="gauge-label">Volatility / Risk</div>
      <div class="gauge-value" id="degenVal">--</div>
      <div class="gauge-desc">Weighted severity momentum (higher = spikier).</div>
    </div>
  </div>
</div>
<button id="snapshotBtn">Request Snapshot</button>
<span id="snapshotInfo"></span>
<div id="configInfo" style="margin-top:8px; font-size:0.85em; color:#888;"></div>
<section id="domainMovers"><h2>Domain Movers</h2><table><thead><tr><th>Domain</th><th>Î”</th><th>Events</th><th>Last Sev</th><th>Score</th></tr></thead><tbody></tbody></table></section>
<section id="casinoMovers"><h2>Casino Movers</h2><table><thead><tr><th>Casino</th><th>Î”</th><th>Events</th><th>Last Sev</th><th>Score</th></tr></thead><tbody></tbody></table></section>
<section id="severity"><h2>Severity Distribution</h2><canvas id="severityChart" height="120"></canvas><div id="severityBars" style="display:none"></div></section>
<section id="sparklines"><h2>Sparklines</h2><div id="sparkDomains"></div><div id="sparkCasinos"></div></section>
<section id="alerts"><h2>Risk Alerts</h2></section>
<section id="ticker"><h2>Live Events</h2><div id="events"></div></section>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const sevEmoji = s => s>=5?'ðŸ”´':s===4?'ðŸŸ ':s===3?'ðŸŸ¡':'ðŸŸ¢';
const snapshotBtn = document.getElementById('snapshotBtn');
let lastSnapshotTs = 0;
const throttleWindow = 5000;
async function refreshRollups(){
  const r = await fetch('/api/rollups/latest').then(r=>r.json());
  const domainMap = r?.domain?.domains || {}; const casinoMap = r?.casino?.casinos || {};
  renderMovers(domainMap, document.querySelector('#domainMovers tbody'));
  renderMovers(casinoMap, document.querySelector('#casinoMovers tbody'));
}
function renderMovers(map, tbody){
  tbody.innerHTML='';
  const entries = Object.entries(map).sort((a,b)=>a[1].totalDelta-b[1].totalDelta);
  entries.slice(0,20).forEach(([k,v])=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${k}</td><td class="${v.totalDelta<0?'neg':'pos'}">${v.totalDelta}</td><td>${v.events}</td><td>${v.lastSeverity||''}</td><td>${v.lastScore||''}</td>`;
    tbody.appendChild(tr);
  });
}
async function refreshSeverity(){
  const s = await fetch('/api/severity').then(r=>r.json());
  const data = Object.entries(s.buckets).map(([sev,count])=>({ sev: parseInt(sev), count }));
  updateSeverityChart(data);
}
async function refreshAlerts(){
  const a = await fetch('/api/alerts').then(r=>r.json());
  const box = document.getElementById('alerts');
  box.querySelectorAll('.alert').forEach(n=>n.remove());
  a.alerts.forEach(al=>{
    const div=document.createElement('div');
    div.className='alert';
    div.textContent=`${al.kind} :: ${al.entity} ${al.totalDelta??''} ${al.severity?('sev '+al.severity):''}`;
    box.appendChild(div);
  });
}
function updateSnapshotInfo(){
  const el=document.getElementById('snapshotInfo');
  if(!lastSnapshotTs){ el.textContent='No snapshot yet'; return; }
  const age = Date.now()-lastSnapshotTs; el.textContent=`Snapshot age: ${(age/1000).toFixed(1)}s`;
  const remaining = throttleWindow - age;
  snapshotBtn.disabled = remaining>0; if(remaining>0){ snapshotBtn.textContent=`Wait ${(remaining/1000).toFixed(1)}s`; } else snapshotBtn.textContent='Request Snapshot';
}
snapshotBtn.onclick=()=>{ fetch('/api/request-snapshot',{method:'POST'}); };
setInterval(()=>{updateSnapshotInfo();},500);
async function refreshHealth(){
  const h = await fetch('/api/health').then(r=>r.json());
  if(h.lastSnapshotTs) lastSnapshotTs = h.lastSnapshotTs;
}
async function refreshConfig(){
  const c = await fetch('/api/config').then(r=>r.json());
  const parts = [`Retention: ${c.retentionDays}d`, `Poll: ${Math.round(c.pollIntervalMs/1000)}s`];
  document.getElementById('configInfo').textContent = parts.join(' â€¢ ');
}
function initSSE(){
  const es = new EventSource('/events');
  es.addEventListener('init', ev=>{ /* ignore initial for now */ });
  es.addEventListener('trust', ev=>{
    const data=JSON.parse(ev.data);
    const wrap=document.getElementById('events');
    const div=document.createElement('div');
    div.className='event';
    div.textContent=`${new Date(data.ts).toLocaleTimeString()} ${sevEmoji(data.severity||1)} ${data.type} ${data.entity} ${data.delta||''}`;
    wrap.prepend(div);
    while(wrap.children.length>200) wrap.removeChild(wrap.lastChild);
  });
}
function loop(){ refreshRollups(); refreshSeverity(); refreshAlerts(); refreshHealth(); refreshConfig(); }
setInterval(loop, 10000);
loop(); initSSE();

// Severity Chart (Chart.js)
let severityChart;
function updateSeverityChart(data){
  const ctx = document.getElementById('severityChart');
  if(!severityChart){
    severityChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: data.map(d=>d.sev), datasets: [{ label:'Severity Events', data: data.map(d=>d.count), backgroundColor: data.map(d=> d.sev>=5?'#ff3d3d':d.sev===4?'#ff7d3d':d.sev===3?'#ffc53d':d.sev===2?'#d2ff3d':'#3dff7d') }] },
      options: { scales: { y: { beginAtZero:true } }, plugins:{ legend:{ display:false } } }
    });
  } else {
    severityChart.data.datasets[0].data = data.map(d=>d.count);
    severityChart.update();
  }
}

// Sparklines
async function refreshSparklines(){
  const d = await fetch('/api/sparklines').then(r=>r.json());
  renderSparklineGroup(d.domains, document.getElementById('sparkDomains'), 'domain');
  renderSparklineGroup(d.casinos, document.getElementById('sparkCasinos'), 'casino');
}
function renderSparklineGroup(items, container, label){
  container.innerHTML='';
  items.forEach(item => {
    const wrap=document.createElement('div'); wrap.style.margin='4px 0';
    const title=document.createElement('div'); title.textContent=`${label}: ${item.entity}`; title.style.fontSize='11px';
    const canvas=document.createElement('canvas'); canvas.width=150; canvas.height=40;
    wrap.appendChild(title); wrap.appendChild(canvas); container.appendChild(wrap);
    drawSparkline(canvas, item.deltas);
  });
}
function drawSparkline(canvas, deltas){
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!deltas.length) return;
  const pad=4; const w=canvas.width - pad*2; const h=canvas.height - pad*2;
  const max=Math.max(...deltas); const min=Math.min(...deltas); const span=max-min || 1;
  ctx.strokeStyle='#4ec9f0'; ctx.lineWidth=1; ctx.beginPath();
  deltas.forEach((v,i)=>{
    const x = pad + (i/(deltas.length-1))*w;
    const y = pad + (1 - (v-min)/span)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
  // zero line
  if(min<0 && max>0){
    const zeroY = pad + (1 - (0-min)/span)*h;
    ctx.strokeStyle='#555'; ctx.beginPath(); ctx.moveTo(pad, zeroY); ctx.lineTo(pad+w, zeroY); ctx.stroke();
  }
}
setInterval(refreshSparklines, 15000); refreshSparklines();

// --- Trust Gauges Update ---
// External gauge config (loaded from /config/gauge-config.json with fallback defaults)
let GAUGE_CONFIG = {
  volatilityInvertMax: 100,
  midSeverityPenalty: 1,
  highSeverityPenalty: 1,
  refreshMs: 15000
};
async function loadGaugeConfig(){
  try {
    const resp = await fetch('/config/gauge-config.json');
    if(resp.ok){
      const data = await resp.json();
      GAUGE_CONFIG = { ...GAUGE_CONFIG, ...data };
    }
  } catch(e){ /* silent */ }
}
const circumference = 2 * Math.PI * 42; // r=42
function setArc(el, pct){
  const clamped = Math.max(0, Math.min(1, pct));
  el.setAttribute('stroke-dasharray', `${(clamped*circumference).toFixed(1)} ${(circumference).toFixed(1)}`);
}
async function updateGauges(){
  try {
    const [rollups, severity] = await Promise.all([
      fetch('/api/rollups/latest').then(r=>r.json()),
      fetch('/api/severity').then(r=>r.json())
    ]);
    // Casino Trust: average lastScore across casinos (0-100 normalized to 0-1)
    const casinos = Object.values(rollups?.casino?.casinos||{});
    const avgScore = casinos.length ? casinos.reduce((a,c)=>a+(c.lastScore||0),0)/casinos.length : 0;
    document.getElementById('casinoVal').textContent = Math.round(avgScore);
    setArc(document.getElementById('casinoArc'), avgScore/100);
    // Payout Reliability: proportion of low severity events (sev 1-2) vs all events
    const buckets = severity?.buckets||{};
    let total=0, low=0; Object.entries(buckets).forEach(([sev,count])=>{ total+=count; if(+sev<=2) low+=count; });
    const payoutReliability = total? (low/total):0;
    document.getElementById('payoutVal').textContent = Math.round(payoutReliability*100)+'%';
    setArc(document.getElementById('payoutArc'), payoutReliability);
    // Volatility / Risk: weighted severity momentum using sev^2 * count / (max theoretical if all sev=5)
    const weighted = Object.entries(buckets).reduce((a,[sev,count])=> a + (Math.pow(+sev,2)*count),0);
    const maxTheoretical = total * Math.pow(5,2);
    const risk = maxTheoretical? weighted / maxTheoretical : 0; // 0-1
    document.getElementById('degenVal').textContent = (risk*100).toFixed(1)+'%';
    setArc(document.getElementById('degenArc'), risk);
  } catch(e){ /* ignore transient */ }
}
// Load external config then start refresh loop
let gaugeIntervalId;
function startGaugeLoop(){
  if(gaugeIntervalId) clearInterval(gaugeIntervalId);
  gaugeIntervalId = setInterval(updateGauges, GAUGE_CONFIG.refreshMs);
  updateGauges();
  const info = document.getElementById('configInfo');
  if(info){
    const existing = info.textContent || '';
    if(!existing.includes('Gauge Refresh')){
      info.textContent = existing + (existing? ' â€¢ ' : '') + `Gauge Refresh: ${(GAUGE_CONFIG.refreshMs/1000).toFixed(1)}s`;
    } else {
      info.textContent = existing.replace(/Gauge Refresh: [0-9.]+s/, `Gauge Refresh: ${(GAUGE_CONFIG.refreshMs/1000).toFixed(1)}s`);
    }
  }
}
loadGaugeConfig().finally(startGaugeLoop);

// --- Admin Panel (query ?admin=1) for live gauge config patch ---
if(window.location.search.includes('admin=1')){
  const panel = document.createElement('div');
  panel.style.margin='18px 0'; panel.style.padding='12px 14px'; panel.style.background='#181818'; panel.style.border='1px solid #333'; panel.style.borderRadius='8px';
  panel.innerHTML = `
    <div style="font-size:12px; font-weight:600; margin-bottom:6px;">Gauge Config Admin</div>
    <form id="gAdminForm" style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
      <label style="display:flex; flex-direction:column; font-size:11px;">refreshMs
        <input name="refreshMs" type="number" min="3000" step="1000" value="${GAUGE_CONFIG.refreshMs}" style="background:#111; color:#eee; border:1px solid #444; padding:4px 6px; width:110px;" />
      </label>
      <label style="display:flex; flex-direction:column; font-size:11px;">volatilityInvertMax
        <input name="volatilityInvertMax" type="number" min="0" value="${GAUGE_CONFIG.volatilityInvertMax}" style="background:#111; color:#eee; border:1px solid #444; padding:4px 6px; width:120px;" />
      </label>
      <label style="display:flex; flex-direction:column; font-size:11px;">midSeverityPenalty
        <input name="midSeverityPenalty" type="number" min="0" value="${GAUGE_CONFIG.midSeverityPenalty}" style="background:#111; color:#eee; border:1px solid #444; padding:4px 6px; width:120px;" />
      </label>
      <label style="display:flex; flex-direction:column; font-size:11px;">highSeverityPenalty
        <input name="highSeverityPenalty" type="number" min="0" value="${GAUGE_CONFIG.highSeverityPenalty}" style="background:#111; color:#eee; border:1px solid #444; padding:4px 6px; width:120px;" />
      </label>
      <button type="submit" style="background:#222; color:#eee; border:1px solid #555; padding:6px 10px;">Patch Config</button>
      <span id="gAdminStatus" style="font-size:11px; color:#888;"></span>
    </form>`;
  document.body.insertBefore(panel, document.getElementById('trustGauges').nextSibling);
  document.getElementById('gAdminForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.target;
    const payload = {};
    ['refreshMs','volatilityInvertMax','midSeverityPenalty','highSeverityPenalty'].forEach(k=>{
      const el=form.querySelector(`[name="${k}"]`); if(el) payload[k]=parseInt(el.value,10);
    });
    const status = document.getElementById('gAdminStatus'); status.textContent='Patchingâ€¦';
    try {
      const resp = await fetch('/api/config/gauges',{ method:'PATCH', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const json = await resp.json();
      if(json.ok){
        GAUGE_CONFIG = { ...GAUGE_CONFIG, ...json.config };
        startGaugeLoop();
        status.textContent='Updated.';
      } else status.textContent='Failed.';
    } catch(err){ status.textContent='Error.'; }
  });
}
</script>
</body>
</html>
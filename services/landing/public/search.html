<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Search – TiltCheck</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="canonical" href="/search" />
  <meta name="description" content="Search TiltCheck pages for topics and answers." />
  <link rel="stylesheet" href="/styles/main.css" />
  <style>
    .search-container { max-width: 760px; margin: 2rem auto; }
    .search-input { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; border: 1px solid #333; border-radius: 6px; background:#111; color:#fff; }
    .search-results { margin-top: 1.5rem; list-style: none; padding: 0; }
    .search-results li { padding: 0.75rem 0; border-bottom: 1px solid #222; }
    .search-results a { font-weight: 600; }
    .search-meta { font-size: 0.8rem; opacity: 0.7; }
    .empty { margin-top: 1rem; opacity: 0.6; }
  </style>
</head>
<body class="content-page">
  <nav class="breadcrumbs"></nav>
  <header class="site-header">
    <div class="container">
      <h1>Search</h1>
      <p>Find content across TiltCheck's public pages.</p>
    </div>
  </header>
  <main class="search-container">
    <input id="search" class="search-input" type="search" placeholder="Type to search (e.g. trust, privacy, faq)..." aria-label="Search text" />
    <ul id="results" class="search-results" aria-live="polite" aria-label="Search results"></ul>
    <p id="empty" class="empty" hidden>No matching results yet.</p>
  </main>
  <footer class="site-footer">
    <div class="container">
      <p><a href="/">← Back Home</a></p>
    </div>
  </footer>
  <script src="/breadcrumbs.js" defer></script>
  <script>
    // Fetch prebuilt index and wire up search
    (async function(){
      const res = await fetch('/search-index.json');
      if(!res.ok){ console.error('Failed to load search index'); return; }
      const data = await res.json();
      // Load lunr from data.index (serialized) dynamically (lunr is server-side built)
      // Minimal loader: we only need lunr.Index.load plus search semantics. The client bundle omitted for CSP; rely on subset logic.
      // Provide a very small lunr-like search using inverted index from serialized form.
      function tokenize(str){ return str.toLowerCase().match(/[a-z0-9]{2,}/g)||[]; }
      // Build naive inverted map from documents (fallback if full lunr not shipped client-side)
      const docs = data.documents;
      const fullDocsMap = {};
      docs.forEach(d=>fullDocsMap[d.id]=d);
      // Lightweight search: scan body tokens (requires full body, but we skipped shipping for size/security) => degrade gracefully
      // For better relevance we request body slices on demand via fetch of page (lazy) after match set.
      const input = document.getElementById('search');
      const resultsEl = document.getElementById('results');
      const emptyEl = document.getElementById('empty');
      function render(list){
        resultsEl.innerHTML='';
        if(!list.length){ emptyEl.hidden=false; return; } else { emptyEl.hidden=true; }
        list.slice(0,20).forEach(r=>{
          const li=document.createElement('li');
          const a=document.createElement('a');
          a.href=r.url; a.textContent=r.title;
          const meta=document.createElement('div'); meta.className='search-meta'; meta.textContent=r.url;
          li.appendChild(a); li.appendChild(meta); resultsEl.appendChild(li);
        });
      }
      function search(q){
        const terms = tokenize(q);
        if(!terms.length){ render([]); return; }
        const matches = docs.filter(d=> terms.every(t=> d.title.toLowerCase().includes(t) || d.id.includes(t)) );
        render(matches);
      }
      input.addEventListener('input', e=> search(e.target.value));
    })();
  </script>
</body>
</html>

<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><title>Trust Engine &amp; Event Schema Migration Guide - TiltCheck</title><meta name="description" content="Date: 2025-11-19"/><link rel="stylesheet" href="/styles/base.css"/><style>body{background:#0a0a0a;color:#e0e0e0;font-family:Inter,system-ui,sans-serif;margin:0;padding:0}main{max-width:900px;margin:0 auto;padding:40px 18px;line-height:1.7}a{color:#00d4aa;text-decoration:none}a:hover{text-decoration:underline}.page-hero{padding:54px 24px 32px;background:linear-gradient(135deg,#121212,#181818);border-bottom:1px solid #222}.page-hero h1{margin:0 0 10px;font-size:2.4rem;background:linear-gradient(135deg,#00d4aa,#00a8ff);-webkit-background-clip:text;color:transparent}.lede{color:#aaa;font-size:1.05rem;max-width:760px}pre{background:#181818;padding:14px 16px;border:1px solid #222;border-radius:8px;overflow:auto;font-size:.85rem}code{font-family:ui-monospace,Monaco,Consolas,monospace;color:#00a8ff}.breadcrumb{font-size:.7rem;letter-spacing:.12em;text-transform:uppercase;color:#888;margin:0 0 12px}.nav-inline{display:flex;gap:20px;align-items:center;font-size:.8rem;padding:10px 20px;background:#111;border-bottom:1px solid #222}nav a{color:#aaa}nav a[aria-current="page"]{color:#00d4aa;font-weight:600}</style></head><body><nav class="nav-inline"><a href="/" >Home</a><a href="/docs/index.html" aria-current="page">Docs</a><a href="/dashboard">Dashboard</a><a href="/about.html">About</a></nav><header class="page-hero"><div class="breadcrumb">Docs / Trust Engine &amp; Event Schema Migration Guide</div><h1>Trust Engine &amp; Event Schema Migration Guide</h1><p class="lede">Date: 2025-11-19</p></header><main id="content"><h1>Trust Engine & Event Schema Migration Guide</h1>

<p>Date: 2025-11-19</p>
<p>Scope: Unify casino trust event payloads across all TiltCheck repos and adopt logging, rotation, severity scaling, and delta fields.</p>

<h2>1. Overview</h2>
<p>Previous trust events varied (e.g. <code>{ domain, score }</code>, <code>{ casino, delta, reason }</code>). New unified schema:</p>
<pre class="code-block" data-lang=""><code>
trust.casino.updated: {
  casinoName: string,
  previousScore?: number,
  newScore?: number,
  delta?: number,
  severity?: number,      // 1‚Äì5
  reason: string,
  source: string,         // emitter module id
  metadata?: Record&lt;string,any&gt;
}
</code></pre>
<p>Rationale: Consistency, downstream simplification, explicit score diff (<code>delta</code>), and provenance (<code>source</code>).</p>

<h2>2. Schema Diff</h2>
<p>| Field | Old Variants | New | Notes |</p>
<p>|-------|--------------|-----|-------|</p>
<p>| <code>casinoName</code> | <code>domain</code>, <code>casino</code> | unified | Use canonical identifier (hostname or configured alias). |</p>
<p>| <code>previousScore</code> | absent | added | Score before mutation. |</p>
<p>| <code>newScore</code> | sometimes <code>score</code> | renamed | Always reflect post-change value. |</p>
<p>| <code>delta</code> | sometimes <code>delta</code> (ambiguous) | normalized | Must equal <code>newScore - previousScore</code>. Negative = penalty. |</p>
<p>| <code>severity</code> | sometimes present | standardized | 1‚Äì5 scale; optional for pure score updates without severity context. |</p>
<p>| <code>reason</code> | present | unchanged | Human-readable explanation. |</p>
<p>| <code>source</code> | absent | added | Emitting module for attribution & auditing. |</p>
<p>| <code>metadata</code> | absent | optional | Flexible extension surface. |</p>

<h2>3. Required Repo Changes</h2>
<h3>A. JustTheTip</h3>
<p>1. Search for <code>trust.casino.updated</code> emissions; replace payload to unified shape.</p>
<p>2. If only user trust updates are emitted, no change; still consume unified casino events for UI.</p>
<p>3. Add parser that expects <code>delta</code> & severity when computing aggregate risk badges.</p>

<h3>B. CollectClock (external repo)</h3>
<p>1. Ensure nerf emissions already send severity; include <code>source</code> and optionally set <code>delta: undefined</code> (CollectClock does not change score directly). Alternatively omit <code>newScore</code>/<code>previousScore</code> for non-score impacting events.</p>
<p>2. Confirm compatibility: downstream must treat missing <code>newScore</code> gracefully.</p>

<h3>C. LinkGaurd (SusLink)</h3>
<p>1. Replace any <code>{ domain, score }</code> trust payload with unified schema including <code>previousScore</code>, <code>newScore</code>, <code>delta</code>.</p>
<p>2. Compute severity: map riskLevel ‚Üí severity (e.g. critical=4, high=3, suspicious=2, safe=1).</p>
<p>3. Apply penalty using severityScale if TrustEngines is centralized; otherwise emit event without score math and let TrustEngines handle the adjustment.</p>

<h3>D. FreeSpinsChannelBot</h3>
<p>1. Update message templating: show <code>Œîscore</code> using <code>delta</code> with color (red negative, green positive).</p>
<p>2. Add severity emoji mapping (1=‚ö†Ô∏è, 5=üõë) if severity present.</p>

<h3>E. TiltCheck Core</h3>
<p>1. Centralize <code>severityScale</code> default in a shared config (<code>packages/config/trust.ts</code>).</p>
<p>2. Export helper <code>computeSeverity(percentDrop: number): number</code>.</p>
<p>3. Provide TypeScript types import path: <code>@tiltcheck/types</code> for TrustCasinoUpdateEvent.</p>

<h3>F. AirdropGatekeeper / DegensAgainstDecency / qualifyfirst</h3>
<p>1. Audit for any trust emissions; unify payload.</p>
<p>2. Avoid adding severity for actions that are purely identity verification; set <code>severity: undefined</code>.</p>

<h2>4. Environment & Logging</h2>
<h3>New Env Flags</h3>
<p>| Service | Flag | Purpose |</p>
<p>|---------|------|---------|</p>
<p>| CollectClock | <code>COLLECTCLOCK_LOG_ERRORS=1</code> | Enable console logger fallback |</p>
<p>| CollectClock | <code>COLLECTCLOCK_LOG_DIR=/path</code> | Persistence + rotation log directory |</p>
<p>| TrustEngines | <code>TRUST_ENGINES_LOG_ERRORS=1</code> | Enable console logger fallback |</p>
<p>| TrustEngines | <code>TRUST_ENGINES_LOG_DIR=/path</code> | Trust logs directory |</p>

<h3>Rotation Defaults</h3>
<p>Size threshold 256KB, retain 3 rotated files. Override via config or env in each service.</p>

<h2>5. Severity & Penalty Mapping</h2>
<p>Default severityScale: <code>[2,4,6,8,12]</code> meaning penalties applied as negative deltas.</p>
<p>Customization example: high volatility environments might prefer <code>[1,3,5,7,11]</code>.</p>
<p>Computation:</p>
<pre class="code-block" data-lang=""><code>
severity = clamp(1,5, ceil(percentDrop * 10))
penalty = -severityScale[severity-1]
</code></pre>

<h2>6. Testing Plan</h2>
<p>| Phase | Tests |</p>
<p>|-------|-------|</p>
<p>| Unit | Event emission payload shape per repo (snapshot + field presence). |</p>
<p>| Integration | CollectClock nerf ‚Üí TrustEngines score delta & dual event emission. |</p>
<p>| Bot Rendering | FreeSpinsChannelBot message formatting with positive & negative deltas. |</p>
<p>| Regression | Ensure legacy consumers (if any) adapted; search for <code>data.domain</code> or <code>data.score</code> usages. |</p>

<p>Add temporary compatibility adapter:</p>
<pre class="code-block" data-lang="ts"><code>
function normalizeOldCasinoEvent(evt: any): TrustCasinoUpdateEvent {
  if (evt.domain &amp;&amp; evt.score !== undefined &amp;&amp; !evt.casinoName) {
    return {
      casinoName: evt.domain,
      previousScore: evt.previousScore,
      newScore: evt.score,
      delta: evt.delta ?? (evt.previousScore !== undefined ? evt.score - evt.previousScore : undefined),
      severity: evt.severity,
      reason: evt.reason || &#39;legacy update&#39;,
      source: evt.source || &#39;legacy-adapter&#39;
    };
  }
  return evt;
}
</code></pre>
<p>Remove adapter after full rollout.</p>

<h2>7. Rollout Strategy</h2>
<p>1. Prepare migration branches concurrently in each repo.</p>
<p>2. Implement compatibility adapter where necessary.</p>
<p>3. Deploy CollectClock & TrustEngines first (emit new schema).</p>
<p>4. Update consumer bots / dashboards.</p>
<p>5. Remove legacy field usage & adapter after 1 release cycle.</p>

<h2>8. Revert Instructions</h2>
<p>If an issue arises:</p>
<p>1. Toggle env <code>TRUST_ENGINES_LOG_ERRORS</code> off to reduce noise.</p>
<p>2. Re-run legacy payload emission by switching to fallback helper (keep a git stash with old emitter function).</p>
<p>3. Monitor error logs for parsing exceptions in bots.</p>

<h2>9. Open Questions</h2>
<ul>
<li>Should severity be included for positive trust adjustments? (Currently yes only for risk/nerf.)</li>
<li>Do we derive severity for multi-factor events (e.g., simultaneous link.flagged + nerf)?</li>
<li>Threshold for volatility-driven dynamic severity scale adaptation.</li>
</ul>

<h2>10. Checklist</h2>
<ul>
<li>[ ] All repos updated to unified schema</li>
<li>[ ] Bots parse <code>delta</code> & severity</li>
<li>[ ] Logging directories set in production</li>
<li>[ ] SeverityScale documented in config package</li>
<li>[ ] Adapter removed post-rollout</li>
</ul>

<p>---</p>
<p>Migration authored by Trust Engine module updates. For clarifications consult <code>services/trust-engines/README.md</code>.</p></main><footer style="padding:40px 24px;text-align:center;font-size:.75rem;color:#666;border-top:1px solid #222">TiltCheck Docs ‚Ä¢ Non-custodial ‚Ä¢ Signals only.</footer></body></html>